---
apiVersion: apps/v1beta2
kind: Deployment
metadata:
  name: "<%= name %>"
  namespace: hedgehog
  annotations:
    com.xing.dynamic-config: enabled
spec:
  revisionHistoryLimit: 2
  replicas: <%= replicas %>
  selector:
    matchLabels:
      app: "<%= name %>"
  # nginx-ingress-controller config update interval is 3 seconds
  minReadySeconds: 4
  strategy:
    rollingUpdate:
      maxUnavailable: <%= replicas == 1 ? 0 : 1 %>
      maxSurge: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: "<%= name %>"
      annotations:
        com.xing.ci-deployment.timestamp: "<%= deployment_id %>"
    spec:
      terminationGracePeriodSeconds: 60
      containers:
      - name: "<%= name %>"
        image: <%= image_with_digest("docker.dc.xing.com/hedgehog/profile-finder-ui:#{env}") %>
        args: <%= args %>
        ports:
        - containerPort: 80
        envFrom: <%= partial "envFrom" %>
        <% if defined?(environment) && !environment.empty? %>
        env: [<%= environment.map { |k,v| "{name: \"#{k.to_s}\", value: \"#{v.to_s}\"}" }.join(",") %>]
        <% end %>
        resources:
          requests:
            cpu: '<%= cpu %>'
            memory: '<%= memory %>'
        livenessProbe:
          httpGet:
            path: /
            port: 80
          failureThreshold: 3
          initialDelaySeconds: 90
          periodSeconds: 5
          timeoutSeconds: 3
